<script src="../../node_modules/aolog/dist/aolog.js"></script>
<script src="../../node_modules/ipfs-api/dist/ipfsapi.js"></script>

<script>
  StarlogBehavior = {
    properties: {
      items: { type: Array,
               value: [] },
      filter: { type: Object,
                 value: {} },
      name: { type: String,
              notify: true },
      icon: { type: String,
              notify: true }
    },

    _onLoad: function () {
      // abstract
    },

    load: function (path, offset, filter, nr) {
      var self = this
      ipfs = ipfsAPI()
      self.path = path
      self.items = []
      self.filter = filter
      self.offset = offset

      self._onLoad()

      ipfs.object.get(path, function (err, res) {
        if (err) throw err

        try {
          self.data = JSON.parse(res.Data)
        } catch (e) {}

        self.linkmap = {}
        for (var i = 0 ; i < res.Links.length ; i++) {
          self.linkmap[res.Links[i].Name] = {
            Name: res.Links[i].Name,
            Size: res.Links[i].Size,
            Hash: res.Links[i].Hash
          }
        }

        if (self.linkmap.icon) {
          self.icon = '/ipfs/' + self.linkmap.icon.Hash
        }

        if (self.data.name) {
          self.name = self.data.name
        }
      })

      aolog.restore(path + '/log', function (err, res) {
        if (err) throw err
        self.log = res
        self.loadMessages(nr)
      })
    },
    loadMessages: function (num) {
      var self = this
      num = num || 5

      if (!this.log) return

      var iteropts = {
        reverse: true,
        offset: self.offset,
        filter: this.filter
      }

      var iter = self.log.iterator(iteropts)

      iter.take(num, function (err, res) {
        if (err) throw err
        if (res.length > num) return self.exausted = true

        for (var i = 0 ; i < res.length ; i++) {
          self.push('items', res[i])
        }
        if (res.length) {
          self.offset = res[res.length - 1].index - 1
        }
      })
    },
    setIcon: function (hash) {
      var self = this

      ipfs.object.stat(hash, function (err, res) {
        if (err) throw err
        self.linkmap.icon = { Name: 'icon',
                              Size: res.CumulativeSize,
                              Hash: hash }
        self.persist()
      })
    },
    persist: function (done) {
      var self = this

      self.log.persist(function (err, persisted) {
        if (err) throw err

        self.linkmap.log.Hash = persisted.Hash
        self.linkmap.log.Size = persisted.Size

        var obj = new ipfs.Buffer(JSON.stringify({
          Data: JSON.stringify(self.data),
          Links: _.map(self.linkmap, function (x) { return x })
        }))

        ipfs.object.put(obj, 'json', function (err, res) {
          if (err) throw err

          self.fire('update', res.Hash)

          ipfs.name.publish(res.Hash, function (err) {
            if (err) throw err
            console.log('published')
          })
        })
      })
    },
    append: function (item) {
      var self = this

      self.log.append(item, function (err, newlog) {
        if (err) throw err
        self.log = newlog
        self.persist(function (err) {
          if (err) throw err
        })
      })
    }
  }
</script>
