<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Starlog</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <script src="node_modules/ipfs-api/dist/ipfsapi.js"></script>

  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <style is="custom-style">
    paper-toolbar {
      height: 60px;
      --paper-toolbar-background: #000;
      --paper-toolbar-color: #fff;
      --paper-toolbar: {
        font-size: 40px;
      };
    }
  </style>

</head>

<body unresolved class="fullbleed">
  <template is="dom-bind" id="app">
    <scroll-events on-bottom="onBottom"></scroll-events>
    <starlog-cache
        on-update="updateHash"
        id="cache"
        items="{{items}}">
    </starlog-cache>
    <div class="layout vertical">
      <iron-pages attr-for-selected="view"
                  class="fit offset"
                  selected="{{view}}">
        <section view="home">
          <paper-drawer-panel
             peeking="true"
             id="drawer"
             drawerToggleAttribute="close">
            <div drawer>
              <paper-material class="menu layout horizontal flex"
                              on-click="onCompose">
                <iron-icon class="narrow" icon="add"></iron-icon>
                <span class="menutext flex">New post</span>
              </paper-material>
              <paper-material class="menu">
                <iron-icon icon="search"></iron-icon>
                <input value="{{titlesearch}}" on-change="searchChange"></input>
              </paper-material>
              <feed-view
                  on-view="viewPost"
                  items="{{items}}"
                  status="{{status}}"
                  editable="true">
              </feed-view>
            </div>
            <paper-material main class="homescreen layout vertical">
              <div class="padded">
                <img class="icon" src="{{icon}}"/>
                <h2>{{name}}</h2>
                <template is="dom-if" if="{{!compose}}">
                  <p>
                    <a href="{{logLink(loghash)}}">Link to this log</a>
                  </p>
                  <p>
                    <a href="{{gatewayLink(loghash)}}">Gateway link</a>
                  </p>
                  <p>
                    Select icon:
                    <ipfs-add-file on-add="updateIcon">
                    </ipfs-add-file>
                  </p>
                </template>
              </div>
              <template is="dom-if" if="{{compose}}">
                <compose-message id="editor"
                                 on-cancel="cancelCompose"
                                 on-post="post">
                </compose-message>
              </template>
            </paper-material>
          </paper-drawer-panel>
        </section>

        <section view="reading">
          <paper-drawer-panel id="drawer2">
            <div drawer>
            </div>
          </paper-drawer-panel>
        </section>

        <section view="starlog">
          <starlog-view
              items="{{items}}"
              on-view="viewPost"
              icon="{{icon}}"
              id="starlog"
              path="{{starlogpath}}"
              seqnr="{{seqnr}}">
          </starlog-view>
        </section>

        <section view="init">
          <initialize-feed on-initialized="feedInitialized"></initialize-feed>
        </section>

      </iron-pages>
      <paper-toolbar class="paper-header">
        <div class="toolbar layout horizontal justified">
          <div>
            <template is="dom-if" if="{{!readonly}}">
              <paper-tabs
                  selected="{{route}}"
                  attr-for-selected="data-route">
                <paper-tab data-route="/home">Home</paper-tab>
              </paper-tabs>
            </template>
          </div>
          <iron-pages attr-for-selected="view"
                      selected="{{view}}">
            <div class="textsearch" view="starlog">
              <input value="{{textsearch}}" on-change="textsearchChange"></input>
              <iron-icon icon="search"></iron-icon>
            </div>
          </iron-pages>
        </div>
      </paper-toolbar>
    </div>
  </template>
</body>

<script>
var app = document.querySelector('#app')

app.properties = {
  route: {
    type: String,
    observer: 'routeChanged'
  }
}

app.updateHash = function (ev) {
  app.loghash = ev.detail
  app.loadLog()
}

app.post = function (env) {
  app.$.drawer.openDrawer()
  app.$.cache.append(env.detail)
  app.$.editor.clear()

  app.compose = false
}

app.cancelCompose = function (env) {
  app.compose = false
}

app.onCompose = function () {
  app.compose = true
  app.$.drawer.closeDrawer()
}

app.feedInitialized = function (ev) {
  app.loghash = ev.detail
  app.initialize()
  page('/home')
}

app.updateIcon = function (ev) {
  app.$.cache.setIcon(ev.detail)
}

app.viewPost = function (ev) {
  app.$.cache.load(app.loghash, ev.detail, 1)
  page('/starlog/' + app.loghash + '/' + ev.detail)
}

app.routeChanged = function () {
  this.view = this.route.split('/')[1]
  page.redirect(this.route)
}

app.onBottom = function () {
  if (app.view == 'starlog') {
    app.$.cache.loadMessages(5)
  }
}

app.logLink = function (hash) {
  return '/starlog/' + hash + '/latest'
}

app.gatewayLink = function (hash) {
  var selfhash = window.location.pathname.split('/')[2]
  return 'http://ipfs.io/ipfs/' + selfhash + '#!/starlog/' + hash + '/latest'
}

app.loadLog = function () {
  if (!app.loghash) return

  ipfs.object.get(app.loghash, function (err, res) {
    if (err) throw err

    var data, type
    try {
      data = JSON.parse(res.Data)
      app.name = data.name
      type = data.type
    } catch (e) {}

    self.linkmap = {}
    for (var i = 0 ; i < res.Links.length ; i++) {
      self.linkmap[res.Links[i].Name] = {
        Name: res.Links[i].Name,
        Size: res.Links[i].Size,
        Hash: res.Links[i].Hash
      }
    }

    if (linkmap.icon) {
      app.icon = '/ipfs/' + linkmap.icon.Hash
    }

    var offset = res.count
    var loadamount = 5
    if (app.seqnr && app.seqnr !== 'latest') {
      offset = app.seqnr
      loadamount = 1
    }

    if (type === 'starlog-feed') {
      app.$.cache.load(app.loghash, offset, loadamount)
    } else {
      page('/init')
    }
  })
}

app.searchChange = function (e) {
  app.$.cache.search(e.target.value ? { title: e.target.value } : {})
  app.$.cache.load()
}

app.textsearchChange = function (e) {
  app.$.cache.search(e.target.value ? { body: e.target.value } : {})
  app.$.starlog.searchView(e.target.value)
  app.$.cache.load()
}

app.initialize = function () {
  var ipfs = ipfsAPI()
  this.page = 0
  app.compose = false

  if (app.loghash) {
    app.loadLog()
  } else if (!app.route || app.route === '/home') {
    ipfs.id(function (err, res) {
      if (err) {
        app.readonly = true
        app.loadLog()
      } else {
        app.readonly = false

        ipfs.name.resolve(res.ID, function (err, res) {
          if (err) throw err
          var split = res.Path.split('/')
          app.loghash = split[split.length - 1]
          app.loadLog()
        })
      }
    })
  }
}

//app.addEventListener('dom-change', app.initialize)

</script>
</html>
