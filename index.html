<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Starlog</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->

  <style is="custom-style">
    paper-toolbar {
      height: 60px;
      --paper-toolbar-background: #000;
      --paper-toolbar-color: #fff;
      --paper-toolbar: {
        font-size: 40px;
      };
    }
  </style>

</head>

<body unresolved class="fullbleed">
  <template is="dom-bind" id="app">
    <ipfs-api id="ipfs"></ipfs-api>
    <div class="layout vertical">
      <iron-pages attr-for-selected="data-route"
                  class="fit offset"
                  selected="{{route}}">
        <section data-route="home">
          <paper-drawer-panel id="drawer">
            <div drawer peeking="true">
              <paper-material class="compose"
                              on-click="onCompose">
                <iron-icon icon="add"></iron-icon>New post
              </paper-material>
              <feed-view id="feed"
                         status="{{status}}"
                         editable="true">
              </feed-view>
            </div>
            <paper-material main class="homescreen layout vertical">
	            <div class="padded">
                <h2>{{name}}</h2>
                <template is="dom-if" if="{{!compose}}">
                  <p>
                    <a href="{{permalink}}">Link to this starlog</a>
                  </p>
                  <p>
                    Select icon
                    <ipfs-add-file on-add="updateIcon">
                    </ipfs-add-file>
                  </p>
                </template>
              </div>
              <template is="dom-if" if="{{compose}}">
                <compose-message id="editor"
                                 on-post="post">
                </compose-message>
              </template>
            </paper-material>
          </paper-drawer-panel>
        </section>

        <section data-route="reading">
          <paper-drawer-panel id="drawer2">
            <div drawer>
            </div>
          </paper-drawer-panel>
        </section>

        <section data-route="starlog">
          <paper-drawer-panel
              force-narrow="true"
              id="drawer">
            <starlog-view
                id="starlog"
                path="{{starlogpath}}"
                seqnr="{{seqnr}}"
                main>
            </starlog-view>
          </paper-drawer-panel>
        </section>

        <section data-route="init">
          <initialize-feed></initialize-feed>
        </section>

      </iron-pages>
      <div class="toolbar layout horizontal justified">
        <template is="dom-if" if="{{id}}">
          <paper-toolbar class="paper-header">
            <paper-tabs selected="{{page}}">
              <paper-tab>Home</paper-tab>
              <paper-tab>Reading</paper-tab>
            </paper-tabs>
          </paper-toolbar>
          <div class="spinner layout horizontal center">
            <span class="status">{{status}}</span>
            <paper-spinner active="{{status}}"></paper-spinner>
          </div>
        </template>
      </div>
    </div>
  </template>
</body>

<script>
var self = document.querySelector('#app')

self.post = function (env) {

  console.log(self.$)

  self.$.drawer.openDrawer()
  self.$.feed.append(env.detail)
  document.querySelector('#editor').clear()

  self.compose = false
}

self.onCompose = function () {
  self.compose = true
}

self.properties = {
  page: {
    type: Number,
    observer: 'pageChanged'
  }
}

self.updateIcon = function (ev) {
  self.$.feed.setIcon(ev.detail)
}

self.pageChanged = function () {
  if (!this.route) return
  if (this.page === 0 && this.route != 'home') {
    page('/')
  } else if (this.page === 1) {
    page('/reading')
  }
}

self.addEventListener('dom-change', function () {
  var ipfs = document.querySelector('ipfs-api').api
  this.page = 0
  self.compose = false

  ipfs.id(function (err, res) {
    if (err) {
      return
    }
    self.id = res.ID

    if (self.id) {
      ipfs.object.get('/ipns/' + self.id, function (err, res) {
        console.log(err)
        if (err) throw err

        var type
        try {
          type = JSON.parse(res.Data).type
          self.name = JSON.parse(res.Data).name
        } catch (e) {}

        if (type === 'starlog-feed') {
          self.$.feed.load(self.id)
        } else {
          page('/init')
        }
      })
    } else {
      // running on gateway, for example
    }
  })
});
</script>
</html>
